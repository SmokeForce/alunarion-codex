---
import Layout from '../layouts/Layout.astro';
import { Redis } from '@upstash/redis';

// Connect to Upstash securely using your .env file
const redis = new Redis({
    url: import.meta.env.UPSTASH_REDIS_REST_URL,
    token: import.meta.env.UPSTASH_REDIS_REST_TOKEN,
});

// Fetch the live database
let cloudData = await redis.get('alunaria-codex');

// Failsafe: if the database is empty, create the skeleton
if (!cloudData) {
    cloudData = {
        atlasData: {}, locationsData: {}, factionsData: {},
        npcData: {}, loreData: {}, traitsData: {},
        skillsData: {}, abilitiesData: {}
    };
}
---

<Layout title="Codex Admin">
    <div class="sidebar">
        <h1>ADMIN EDIT</h1>
        <button class="nav-btn active" data-tab="atlasData">Atlas (Map)</button>
        <button class="nav-btn" data-tab="locationsData">Locations</button>
        <button class="nav-btn" data-tab="factionsData">Factions</button>
        <button class="nav-btn" data-tab="npcData">NPCs</button>
        <button class="nav-btn" data-tab="loreData">Lore</button>
        <button class="nav-btn" data-tab="traitsData">Traits</button>
        <button class="nav-btn" data-tab="skillsData">Skills</button>
        <button class="nav-btn" data-tab="abilitiesData">Abilities</button>
        <button id="logoutBtn" class="nav-btn" style="color: var(--danger); margin-top: 10px;">Logout</button>

        <div style="margin-top: auto; padding: 20px;">
            <a href="/" style="color: var(--text-muted); text-decoration: none; font-size: 0.85rem;">&larr; Back to Codex</a>
        </div>
    </div>

    <div class="main-content">
        <div class="filter-bar" style="justify-content: space-between;">
            <div>
                <button id="saveBtn" class="btn btn-save">Save to Cloud</button>
                <button id="formatBtn" class="btn btn-format">Format JSON</button>
            </div>
            <span id="statusMsg" style="font-weight: bold;"></span>
        </div>

        <div class="content-scroll" style="display: flex; flex-direction: column; padding: 0;">
            <textarea id="jsonEditor" spellcheck="false"></textarea>
        </div>
    </div>

    <style>
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9rem; margin-right: 10px; }
        .btn-save { background-color: #4CAF50; color: white; }
        .btn-save:hover { background-color: #45a049; }
        .btn-format { background-color: var(--bg-dark); color: var(--accent); border: 1px solid var(--accent); }
        .btn-format:hover { background-color: var(--bg-panel); }

        #jsonEditor {
            flex-grow: 1; width: 100%; height: 100%;
            background-color: #0d0d0d; color: #56b6c2;
            font-family: Consolas, 'Courier New', monospace;
            font-size: 14px; line-height: 1.5; padding: 20px;
            border: none; resize: none; white-space: pre;
            overflow-wrap: normal; overflow-x: scroll;
        }
        #jsonEditor:focus { outline: none; }
    </style>

    <script is:inline define:vars={{ cloudData }}>
        window.CLOUD_CODEX_DATA = cloudData;
    </script>

    <script>
        // 2. We DO NOT import codexData.js here anymore!
        // We just read the global variable we set right above this.
        let allData = window.CLOUD_CODEX_DATA || {};

        // Safety check to ensure all tabs exist
        const defaultKeys = ['atlasData', 'locationsData', 'factionsData', 'npcData', 'loreData', 'traitsData', 'skillsData', 'abilitiesData'];
        defaultKeys.forEach(key => {
            if (!allData[key]) allData[key] = {};
        });

        let currentTab = 'atlasData';

        const editor = document.getElementById('jsonEditor');
        const statusMsg = document.getElementById('statusMsg');
        const saveBtn = document.getElementById('saveBtn');
        const formatBtn = document.getElementById('formatBtn');

        // Initialize editor
        if (editor) editor.value = JSON.stringify(allData[currentTab], null, 2);

        // Handle Sidebar Clicks
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget;
                const newTab = target.dataset.tab;

                if (newTab === currentTab) return;

                // Attempt to save current tab to memory
                try {
                    allData[currentTab] = JSON.parse(editor.value);
                } catch (err) {
                    const proceed = confirm("Syntax error in your JSON. Switch tabs anyway and lose changes?");
                    if (!proceed) return;
                }

                currentTab = newTab;

                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                target.classList.add('active');

                if (editor) editor.value = JSON.stringify(allData[currentTab], null, 2);
                if (statusMsg) statusMsg.innerText = '';
            });
        });

        // Format Button
        if (formatBtn) {
            formatBtn.addEventListener('click', () => {
                try {
                    const parsed = JSON.parse(editor.value);
                    if (editor) editor.value = JSON.stringify(parsed, null, 2);
                    if (statusMsg) {
                        statusMsg.style.color = 'var(--text-main)';
                        statusMsg.innerText = 'JSON Formatted!';
                    }
                } catch (err) {
                    if (statusMsg) {
                        statusMsg.style.color = 'var(--danger)';
                        statusMsg.innerText = 'Cannot format: Invalid JSON syntax.';
                    }
                }
            });
        }

        // Save Button -> Sends to /api/save
        if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
                try {
                    const parsedData = JSON.parse(editor.value);
                    allData[currentTab] = parsedData;

                    if (statusMsg) {
                        statusMsg.style.color = 'var(--text-main)';
                        statusMsg.innerText = 'Saving to Cloud...';
                    }

                    const response = await fetch('/api/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(allData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        if (statusMsg) {
                            statusMsg.style.color = '#4CAF50';
                            statusMsg.innerText = 'Saved securely to Upstash Redis!';
                        }
                    } else {
                        throw new Error(result.error);
                    }

                } catch (err) {
                    console.error(err);
                    if (statusMsg) {
                        statusMsg.style.color = 'var(--danger)';
                        statusMsg.innerText = `Error: Invalid JSON syntax. Check your commas!`;
                    }
                }
            });
        }
        document.getElementById('logoutBtn')?.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    // Force a hard redirect to the login page
                    window.location.href = '/login';
                } else {
                    console.error("Logout failed on server.");
                }
            } catch (err) {
                console.error("Network error during logout:", err);
            }
        });
    </script>
</Layout>